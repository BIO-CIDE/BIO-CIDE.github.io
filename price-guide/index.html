<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Price Lookup Tool</title>

    <!-- Tailwind CSS CDN for styling -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">

    <!-- React and ReactDOM CDN -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

    <!-- SheetJS for parsing Excel files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.9/xlsx.full.min.js"></script>

    <!-- Babel for JSX support -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background-color: #f0f0f0; }

        .row:hover {
            background-color: #e2e8f0;
            transition: background-color 0.3s ease;
        }

        .input-focused {
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .btn {
            background-color: #3498db;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .btn:hover {
            background-color: #2980b9;
        }

        .cart-item {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body>

<div id="root"></div>

<script type="text/babel">
    const { useState, useEffect } = React;

    const PriceLookupTool = () => {
        const [csvData, setCsvData] = useState([]);
        const [searchTerm, setSearchTerm] = useState('');
        const [lastUpdated, setLastUpdated] = useState('');
        const [cart, setCart] = useState([]);
        const [totalAmount, setTotalAmount] = useState(0);

        // Fetch the Excel file from the same directory
        const fetchExcelFile = async () => {
            try {
                const fileUrl = "Source.xlsx"; // Excel file in the same directory
                
                const response = await fetch(fileUrl);
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);

                const fileBlob = await response.blob();
                parseExcelFile(fileBlob);

                setLastUpdated(new Date().toLocaleString());
            } catch (error) {
                console.error('Error fetching the Excel file:', error);
            }
        };

        // Parse the Excel file using SheetJS
        const parseExcelFile = (fileBlob) => {
            const reader = new FileReader();
            reader.onload = function (e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                const rawData = XLSX.utils.sheet_to_json(sheet, { header: 1 });

                const filteredData = rawData.filter(row => {
                    const m3PartNumber = row[1]; 
                    return m3PartNumber && m3PartNumber.startsWith("Q");
                }).map(row => ({
                    bciNumber: row[0],
                    description: row[2],
                    uom: row[3],
                    distPrice: formatPrice(row[4]), // Format price safely
                }));

                setCsvData(filteredData);
            };
            reader.readAsArrayBuffer(fileBlob);
        };

        // Helper function to safely format price
        const formatPrice = (price) => {
            if (price === undefined || price === null) return '0.00'; // Handle missing/invalid price
            if (typeof price === 'number') return price.toFixed(2); // If price is already a number
            if (typeof price === 'string') return parseFloat(price.replace(/[^\d.-]/g, '')).toFixed(2); // If price is a string, remove non-numeric characters
            return '0.00'; // Default for other invalid cases
        };

        // Fetch the Excel file on mount
        useEffect(() => {
            fetchExcelFile();
        }, []);

        // Search filter
        const handleSearch = (event) => setSearchTerm(event.target.value.toLowerCase());

        const filteredData = csvData.filter(
            (row) =>
                row.bciNumber?.toLowerCase().includes(searchTerm) ||
                row.description?.toLowerCase().includes(searchTerm)
        );

        // Add item to cart
        const addToCart = (item, quantity) => {
            const updatedCart = [...cart];
            const existingItem = updatedCart.find(i => i.bciNumber === item.bciNumber);
            const priceTotal = item.distPrice * quantity;

            if (existingItem) {
                existingItem.quantity = quantity;
                existingItem.total = priceTotal;
            } else {
                updatedCart.push({ ...item, quantity, total: priceTotal });
            }

            setCart(updatedCart);
            updateTotalAmount(updatedCart);
        };

        const updateTotalAmount = (updatedCart) => {
            const total = updatedCart.reduce((sum, item) => sum + item.total, 0);
            setTotalAmount(total.toFixed(2));
        };

        return (
            <div className="p-4 sm:p-6 md:p-8 mx-200 bg-white shadow-lg rounded-lg">
                <h1 className="text-2xl sm:text-3xl font-bold mb-6 sm:mb-8 text-center text-gray-800">Price Lookup Tool</h1>

                <div className="text-right text-sm text-gray-500">
                    Last updated: {lastUpdated || 'No file uploaded'}
                </div>

                {/* Search input */}
                <input
                    type="text"
                    className={`mt-4 p-2 w-full border border-gray-300 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 ${searchTerm && 'input-focused'}`}
                    placeholder="Search by BCI # or Description"
                    value={searchTerm}
                    onChange={handleSearch}
                />

                {/* Display results in table */}
                <table className="min-w-full table-auto mt-6 bg-white shadow-md rounded-lg">
                    <thead>
                        <tr className="bg-gray-100 border-b">
                            <th className="py-3 px-4 text-left text-sm font-semibold text-gray-600">BCI #</th>
                            <th className="py-3 px-4 text-left text-sm font-semibold text-gray-600">Description</th>
                            <th className="py-3 px-4 text-left text-sm font-semibold text-gray-600">UOM</th>
                            <th className="py-3 px-4 text-left text-sm font-semibold text-gray-600">Price</th>
                            <th className="py-3 px-4 text-left text-sm font-semibold text-gray-600">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {filteredData.length > 0 ? (
                            filteredData.map((row, index) => (
                                <tr key={index} className={`border-b row ${index % 2 === 0 ? 'bg-gray-100' : 'bg-white'}`}>
                                    <td className="py-2 px-4">{row.bciNumber}</td>
                                    <td className="py-2 px-4">{row.description}</td>
                                    <td className="py-2 px-4">{row.uom}</td>
                                    <td className="py-2 px-4">${row.distPrice}</td>
                                    <td className="py-2 px-4">
                                        <input
                                            type="number"
                                            min="1"
                                            placeholder="Qty"
                                            className="border rounded px-2 py-1 w-16"
                                            onChange={(e) => addToCart(row, Number(e.target.value))}
                                        />
                                    </td>
                                </tr>
                            ))
                        ) : (
                            <tr>
                                <td colSpan="5" className="text-center py-4">No data found</td>
                            </tr>
                        )}
                    </tbody>
                </table>

                {/* Cart Section */}
                {cart.length > 0 && (
                    <div className="mt-6">
                        <h2 className="text-xl font-semibold mb-4">Cart</h2>
                        {cart.map((item, index) => (
                            <div key={index} className="cart-item">
                                <div><strong>{item.description}</strong> ({item.bciNumber})</div>
                                <div>Quantity: {item.quantity}</div>
                                <div>Total: ${item.total.toFixed(2)}</div>
                            </div>
                        ))}
                        <div className="text-right text-xl font-semibold">Total: ${totalAmount}</div>
                        <button
                            className="btn mt-4"
                            onClick={() => navigator.clipboard.writeText(JSON.stringify(cart, null, 2))}
                        >
                            Copy Cart
                        </button>
                    </div>
                )}
            </div>
        );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<PriceLookupTool />);
</script>

</body>
</html>
